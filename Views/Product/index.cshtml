@model FipsFrontend.Models.ProductViewModel
@{
    ViewData["Title"] = Model.Product.Title;
}



@section BeforeContent {
    <div class="dfe-masthead dfe-masthead--with-links govuk-!-padding-bottom-3 govuk-!-margin-bottom-3">
        <div class="govuk-width-container">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                    <a href="@GetBackLink(ViewData["ReturnUrl"]?.ToString())" class="govuk-back-link">@GetBackLinkText(ViewData["ReturnUrl"]?.ToString())</a>
                    <h1 class="govuk-heading-l dfe-masthead--title">
                        @Model.Product.Title
                    </h1>
                    <table class="govuk-table">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row">
                                <th class="govuk-table__header govuk-!-width-one-quarter">Phase</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">Business area</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">Contacts</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">View product</th>
                            </tr>
                        </thead>
                        <tbody class="govuk-table__body">
                            <tr class="govuk-table__row">
                               
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">Phase: </span>
                                    @{
                                        var phaseCategory = Model.Product.CategoryValues?.FirstOrDefault(cv => cv.CategoryType?.Name?.Equals("Phase", StringComparison.OrdinalIgnoreCase) == true);
                                    }
                                    @if (phaseCategory != null)
                                    {
                                        <strong class="govuk-tag govuk-tag--blue">@phaseCategory.Name</strong>
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">Business area: </span>
                                    @{
                                        var businessAreaCategory = Model.Product.CategoryValues?.FirstOrDefault(cv => cv.CategoryType?.Name?.Equals("Business area", StringComparison.OrdinalIgnoreCase) == true);
                                    }
                                    @if (businessAreaCategory != null)
                                    {
                                        @businessAreaCategory.Name
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    @{
                                        var totalContacts = (Model.Product.ServiceOwner?.Count ?? 0) +
                                                             (Model.Product.ProductManager?.Count ?? 0) +
                                                             (Model.Product.DeliveryManager?.Count ?? 0) +
                                                             (Model.Product.InformationAssetOwner?.Count ?? 0) +
                                                             (Model.Product.SeniorResponsibleOfficer?.Count ?? 0);
                                    }
                                    @if (totalContacts > 0)
                                    {
                                        <a href="#contacts" class="govuk-link" rel="noopener noreferrer">@totalContacts contacts</a>
                                    }
                                    else
                                    {
                                        <span>0 contacts</span>
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">View product: </span>
                                    @if (!string.IsNullOrWhiteSpace(Model.Product.ProductUrl))
                                    {
                                        <a href="@Model.Product.ProductUrl" class="govuk-link" target="_blank" rel="noopener noreferrer">View product</a>
                                    }
                                    else
                                    {
                                        <span>Not available</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-one-quarter">
        <nav aria-label="Components Menu" class="dfe-vertical-nav">
            <button type="button" class="dfe-vertical-nav__toggle dfe-js-vertical-nav-toggle" aria-controls="side-navigation" hidden="" aria-expanded="false">
                Product navigation
            </button>
            <ul class="dfe-vertical-nav__section" id="side-navigation">
                <li class="dfe-vertical-nav__section-item dfe-vertical-nav__section-item--current">
                    <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)@(GetReturnUrlQueryString(ViewData["ReturnUrl"]?.ToString()))">Overview</a>
                </li>
                <li class="dfe-vertical-nav__section-item">
                    <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)/categories@(GetReturnUrlQueryString(ViewData["ReturnUrl"]?.ToString()))">Categories</a>
                </li>
                @if (ViewData["AssuranceEnabled"] as bool? == true)
                {
                    <li class="dfe-vertical-nav__section-item">
                        <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)/assurance@(GetReturnUrlQueryString(ViewData["ReturnUrl"]?.ToString()))">Assurance</a>
                    </li>
                }
                @if (ViewData["EditProductEnabled"] as bool? == true)
                {
                    <li class="dfe-vertical-nav__section-item">
                        <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)/propose-change@(GetReturnUrlQueryString(ViewData["ReturnUrl"]?.ToString()))">Propose a change</a>
                    </li>
                }
            </ul>
        </nav>
    </div>

    <div class="govuk-grid-column-three-quarters">
       
        <h2 class="govuk-heading-m">Description</h2>
        
        @if (!string.IsNullOrEmpty(Model.Product.LongDescription))
        {
            <pre class="govuk-body pre-wrap-text">@Model.Product.LongDescription</pre>
        }
        else if (!string.IsNullOrEmpty(Model.Product.ShortDescription))
        {
            <pre class="govuk-body pre-wrap-text">@Model.Product.ShortDescription</pre>
        }

      

        <h2 class="govuk-heading-m" id="contacts">Responsibilities and contacts</h2>

        @{
            var serviceOwners = Model.Product.ServiceOwner?.Where(so => so != null).ToList() ?? new List<EntraUser>();
            var productManagers = Model.Product.ProductManager?.Where(pm => pm != null).ToList() ?? new List<EntraUser>();
            var deliveryManagers = Model.Product.DeliveryManager?.Where(dm => dm != null).ToList() ?? new List<EntraUser>();
            var informationAssetOwners = Model.Product.InformationAssetOwner?.Where(iao => iao != null).ToList() ?? new List<EntraUser>();
            var seniorResponsibleOfficers = Model.Product.SeniorResponsibleOfficer?.Where(sro => sro != null).ToList() ?? new List<EntraUser>();
            
            var hasContacts = serviceOwners.Any() || productManagers.Any() || deliveryManagers.Any() || 
                             informationAssetOwners.Any() || seniorResponsibleOfficers.Any();
        }

        @if (hasContacts)
        {
            <dl class="govuk-summary-list">
                @foreach (var serviceOwner in serviceOwners)
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Service Owner
                        </dt>
                        <dd class="govuk-summary-list__value">
                            @if (!string.IsNullOrEmpty(serviceOwner.EmailAddress))
                            {
                                <a href="mailto:@serviceOwner.EmailAddress" class="govuk-link" rel="noopener noreferrer">@GetEntraUserDisplayName(serviceOwner)</a>
                            }
                            else
                            {
                                @GetEntraUserDisplayName(serviceOwner)
                            }
                        </dd>
                    </div>
                }

                @foreach (var productManager in productManagers)
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Product Manager
                        </dt>
                        <dd class="govuk-summary-list__value">
                            @if (!string.IsNullOrEmpty(productManager.EmailAddress))
                            {
                                <a href="mailto:@productManager.EmailAddress" class="govuk-link" rel="noopener noreferrer">@GetEntraUserDisplayName(productManager)</a>
                            }
                            else
                            {
                                @GetEntraUserDisplayName(productManager)
                            }
                        </dd>
                    </div>
                }

                @foreach (var deliveryManager in deliveryManagers)
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Delivery Manager
                        </dt>
                        <dd class="govuk-summary-list__value">
                            @if (!string.IsNullOrEmpty(deliveryManager.EmailAddress))
                            {
                                <a href="mailto:@deliveryManager.EmailAddress" class="govuk-link" rel="noopener noreferrer">@GetEntraUserDisplayName(deliveryManager)</a>
                            }
                            else
                            {
                                @GetEntraUserDisplayName(deliveryManager)
                            }
                        </dd>
                    </div>
                }

                @foreach (var informationAssetOwner in informationAssetOwners)
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Information Asset Owner
                        </dt>
                        <dd class="govuk-summary-list__value">
                            @if (!string.IsNullOrEmpty(informationAssetOwner.EmailAddress))
                            {
                                <a href="mailto:@informationAssetOwner.EmailAddress" class="govuk-link" rel="noopener noreferrer">@GetEntraUserDisplayName(informationAssetOwner)</a>
                            }
                            else
                            {
                                @GetEntraUserDisplayName(informationAssetOwner)
                            }
                        </dd>
                    </div>
                }

                @foreach (var seniorResponsibleOfficer in seniorResponsibleOfficers)
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">
                            Senior Responsible Officer
                        </dt>
                        <dd class="govuk-summary-list__value">
                            @if (!string.IsNullOrEmpty(seniorResponsibleOfficer.EmailAddress))
                            {
                                <a href="mailto:@seniorResponsibleOfficer.EmailAddress" class="govuk-link" rel="noopener noreferrer">@GetEntraUserDisplayName(seniorResponsibleOfficer)</a>
                            }
                            else
                            {
                                @GetEntraUserDisplayName(seniorResponsibleOfficer)
                            }
                        </dd>
                    </div>
                }
            </dl>
        }
        else
        {
            <p class="govuk-body">No contact information available.</p>
        }

<details class="govuk-details">
  <summary class="govuk-details__summary">
    <span class="govuk-details__summary-text">
      Product identifiers
    </span>
  </summary>
  <div class="govuk-details__text">
        @if (!string.IsNullOrEmpty(Model.Product.FipsId) ||
             !string.IsNullOrEmpty(Model.Product.CmdbSysId) ||
             !string.IsNullOrEmpty(Model.Product.DocumentId))
        {
            <dl class="govuk-summary-list">
                @if (!string.IsNullOrEmpty(Model.Product.FipsId))
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">FIPS ID</dt>
                        <dd class="govuk-summary-list__value">@Model.Product.FipsId</dd>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.Product.DocumentId))
                {
                    <div class="govuk-summary-list__row">
                        <dt class="govuk-summary-list__key">Document ID</dt>
                        <dd class="govuk-summary-list__value">@Model.Product.DocumentId</dd>
                    </div>
                }
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">CMDB System ID</dt>
                    <dd class="govuk-summary-list__value">
                        @if (!string.IsNullOrEmpty(Model.Product.CmdbSysId))
                        {
                            @Model.Product.CmdbSysId
                        }
                        else
                        {
                            <span class="govuk-body-s govuk-!-font-weight-normal">No CMDB entry found</span>
                        }
                    </dd>
                </div>
            </dl>
        }
  </div>
</details>

    </div>
</div>

@functions {
    public string GetBackLink(string? returnUrl)
    {
        // If returnUrl is provided, use it
        if (!string.IsNullOrEmpty(returnUrl))
        {
            return returnUrl;
        }
        
        // Check if there's a referrer and if it's from the products page with filters
        var referrer = Context.Request.Headers["Referer"].FirstOrDefault();
        
        if (!string.IsNullOrEmpty(referrer) && 
            referrer.Contains("/products") && 
            (referrer.Contains("?") || referrer.Contains("&")))
        {
            // User came from products page with filters - preserve them
            return referrer;
        }
        
        // Default back to products page
        return "/products";
    }
    
    public string GetBackLinkText(string? returnUrl)
    {
        // If returnUrl is provided, check if it has filters
        if (!string.IsNullOrEmpty(returnUrl))
        {
            if (returnUrl.Contains("/products") && (returnUrl.Contains("?") || returnUrl.Contains("&")))
            {
                return "Back to results";
            }
            return "Back to products";
        }
        
        var referrer = Context.Request.Headers["Referer"].FirstOrDefault();
        
        if (!string.IsNullOrEmpty(referrer) && 
            referrer.Contains("/products") && 
            (referrer.Contains("?") || referrer.Contains("&")))
        {
            return "Back to results";
        }
        
        return "Back to products";
    }
    
    public string GetReturnUrlQueryString(string? returnUrl)
    {
        if (!string.IsNullOrEmpty(returnUrl))
        {
            return $"?returnUrl={Uri.EscapeDataString(returnUrl)}";
        }
        return string.Empty;
    }
    
    public string GetFriendlyRoleName(string role)
    {
        return role switch
        {
            "delivery_manager" => "Delivery Manager",
            "information_asset_owner" => "Information Asset Owner",
            "product_manager" => "Product Manager",
            "reporting" => "Reporting",
            "senior_responsible_owner" => "Senior Responsible Owner",
            "service_owner" => "Service Owner",
            _ => role // Return original if no mapping found
        };
    }

    public string GetEntraUserDisplayName(EntraUser? user)
    {
        if (user == null)
        {
            return "Contact";
        }

        if (!string.IsNullOrWhiteSpace(user.DisplayName))
        {
            return user.DisplayName;
        }

        var firstName = user.FirstName?.Trim() ?? string.Empty;
        var lastName = user.LastName?.Trim() ?? string.Empty;
        var fullName = $"{firstName} {lastName}".Trim();
        if (!string.IsNullOrWhiteSpace(fullName))
        {
            return fullName;
        }

        if (!string.IsNullOrWhiteSpace(user.EmailAddress))
        {
            return user.EmailAddress;
        }

        return "Contact";
    }
}
