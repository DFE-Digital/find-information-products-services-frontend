@using FipsFrontend.Helpers
@model ProposeChangeViewModel
@{ ViewData["Title"] = Model.PageTitle; } 
@{ ViewData["Description"] = Model.PageDescription; }

@section BeforeContent {
        <div class="dfe-masthead dfe-masthead--with-links govuk-!-padding-bottom-3 govuk-!-margin-bottom-3">
        <div class="govuk-width-container">
            <div class="govuk-grid-row">
                <div class="govuk-grid-column-full">
                    <a href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)" class="govuk-back-link">Back to product</a>
                    
                     <span class="govuk-caption-m">@Model.Product.FipsId</span>
                     <h1 class="govuk-heading-l dfe-masthead--title">
                        @Model.Product.Title
                    </h1>
                    <table class="govuk-table">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row">
                                <th class="govuk-table__header govuk-!-width-one-quarter">Phase</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">Business area</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">Contacts</th>
                                <th class="govuk-table__header govuk-!-width-one-quarter">View product</th>
                            </tr>
                        </thead>
                        <tbody class="govuk-table__body">
                            <tr class="govuk-table__row">
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">Phase: </span>
                                    @{
                                        var phaseCategory = Model.Product.CategoryValues?.FirstOrDefault(cv => cv.CategoryType?.Name?.Equals("Phase", StringComparison.OrdinalIgnoreCase) == true);
                                    }
                                    @if (phaseCategory != null)
                                    {
                                        <strong class="govuk-tag govuk-tag--blue">@phaseCategory.Name</strong>
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">Business area: </span>
                                    @{
                                        var businessAreaCategory = Model.Product.CategoryValues?.FirstOrDefault(cv => cv.CategoryType?.Name?.Equals("Business area", StringComparison.OrdinalIgnoreCase) == true);
                                    }
                                    @if (businessAreaCategory != null)
                                    {
                                        @businessAreaCategory.Name
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    @if (Model.Product.ProductContacts?.Any() == true)
                                    {
                                        <a href="#contacts" class="govuk-link" rel="noopener noreferrer">@Model.Product.ProductContacts.Count contacts</a>
                                    }
                                    else
                                    {
                                        <span>0 contacts</span>
                                    }
                                </td>
                                <td class="govuk-table__cell">
                                    <span class="govuk-visually-hidden">View product: </span>
                                    @if (!string.IsNullOrWhiteSpace(Model.Product.ProductUrl))
                                    {
                                        <a href="@Model.Product.ProductUrl" class="govuk-link" target="_blank" rel="noopener noreferrer">View product</a>
                                    }
                                    else
                                    {
                                        <span>Not available</span>
                                    }
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
}


<div class="govuk-grid-row">
  <div class="govuk-grid-column-one-quarter">

        <nav aria-label="Components Menu" class="dfe-vertical-nav">
            <button type="button" class="dfe-vertical-nav__toggle dfe-js-vertical-nav-toggle" aria-controls="side-navigation" hidden="" aria-expanded="false">
                Product navigation
            </button>
            <ul class="dfe-vertical-nav__section" id="side-navigation">
                <li class="dfe-vertical-nav__section-item">
                    <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)">Overview</a>
                </li>
                <li class="dfe-vertical-nav__section-item">
                    <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)/categories">Categories</a>
                </li>
                @if (ViewData["AssuranceEnabled"] as bool? == true)
                {
                    <li class="dfe-vertical-nav__section-item">
                        <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)/assurance">Assurance</a>
                    </li>
                } 
                @if (ViewData["EditProductEnabled"] as bool? == true)
                {
                    <li class="dfe-vertical-nav__section-item  dfe-vertical-nav__section-item--current">
                        <a class="dfe-vertical-nav__link govuk-link govuk-link--no-visited-state govuk-link--no-underline" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)/propose-change">Propose a change</a>
                    </li>
                }
            </ul>
        </nav>

  </div>

  <div class="govuk-grid-column-three-quarters">
    
    @if (ViewData["SuccessMessage"] != null)
    {
        <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
            <div class="govuk-notification-banner__header">
                <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
                    Success
                </h2>
            </div>
            <div class="govuk-notification-banner__content">
                <p class="govuk-notification-banner__heading">
                    Your proposed changes have been submitted. The FIPS team may contact you if additional action or information is needed.
                </p>
            </div>
        </div>
    }
    
    @if (ViewData.ModelState.ErrorCount > 0 && ViewData.ModelState[""]?.Errors.Count > 0)
    {
        <div class="govuk-error-summary" role="alert" aria-labelledby="error-summary-title" tabindex="-1" data-module="govuk-error-summary">
            <h2 class="govuk-error-summary__title" id="error-summary-title">
                There is a problem
            </h2>
            <div class="govuk-error-summary__body">
                <ul class="govuk-list govuk-error-summary__list">
                    @foreach (var error in ViewData.ModelState[""]?.Errors ?? new Microsoft.AspNetCore.Mvc.ModelBinding.ModelErrorCollection())
                    {
                        <li>@error.ErrorMessage</li>
                    }
                </ul>
            </div>
        </div>
    }

   
   

    <form asp-action="ProposeChange" asp-route-fipsid="@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)" method="post" novalidate>
        @Html.AntiForgeryToken()

        <h2 class="govuk-heading-l">Propose a change to product details</h2>

             <p class="govuk-body">Use this form to propose changes to this product's information. An administrator will review your suggestions before they are added.</p>
 
<div class="govuk-inset-text">
 This form should only be submitted by a permanent member of DfE staff.
</div>


        
        <div class="govuk-form-group @(ViewData.ModelState["ProposedTitle"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedTitle">
                Product title
            </label>
            <div id="ProposedTitle-hint" class="govuk-hint">
                Current: @Model.Product.Title
            </div>
            @if (ViewData.ModelState["ProposedTitle"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedTitle"]?.Errors.First().ErrorMessage
                </span>
            }
            <input class="govuk-input @(ViewData.ModelState["ProposedTitle"]?.Errors.Count > 0 ? "govuk-input--error" : "")" 
                   id="ProposedTitle" 
                   name="ProposedTitle" 
                   type="text" 
                   value="@Model.ProposedTitle"
                   maxlength="255"
                   aria-describedby="@(ViewData.ModelState["ProposedTitle"]?.Errors.Count > 0 ? "ProposedTitle-error ProposedTitle-hint" : "ProposedTitle-hint")">
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedShortDescription"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedShortDescription">
                Short description
            </label>
            <div id="ProposedShortDescription-hint" class="govuk-hint">
                Current: @Model.Product.ShortDescription
            </div>
            @if (ViewData.ModelState["ProposedShortDescription"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedShortDescription"]?.Errors.First().ErrorMessage
                </span>
            }
            <textarea class="govuk-textarea @(ViewData.ModelState["ProposedShortDescription"]?.Errors.Count > 0 ? "govuk-textarea--error" : "")" 
                      id="ProposedShortDescription" 
                      name="ProposedShortDescription" 
                      rows="3"
                      maxlength="500"
                      aria-describedby="@(ViewData.ModelState["ProposedShortDescription"]?.Errors.Count > 0 ? "ProposedShortDescription-error ProposedShortDescription-hint" : "ProposedShortDescription-hint")">@Model.ProposedShortDescription</textarea>
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedLongDescription"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedLongDescription">
                Long description
            </label>
            <div id="ProposedLongDescription-hint" class="govuk-hint">
                Current: @(Model.Product.LongDescription ?? "(none)")
            </div>
            @if (ViewData.ModelState["ProposedLongDescription"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedLongDescription"]?.Errors.First().ErrorMessage
                </span>
            }
            <textarea class="govuk-textarea @(ViewData.ModelState["ProposedLongDescription"]?.Errors.Count > 0 ? "govuk-textarea--error" : "")" 
                      id="ProposedLongDescription" 
                      name="ProposedLongDescription" 
                      rows="5"
                      maxlength="2000"
                      aria-describedby="@(ViewData.ModelState["ProposedLongDescription"]?.Errors.Count > 0 ? "ProposedLongDescription-error ProposedLongDescription-hint" : "ProposedLongDescription-hint")">@Model.ProposedLongDescription</textarea>
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedProductUrl"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedProductUrl">
                Product URL
            </label>
            <div id="ProposedProductUrl-hint" class="govuk-hint">
                Current: @(Model.Product.ProductUrl ?? "(none)")
            </div>
            @if (ViewData.ModelState["ProposedProductUrl"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedProductUrl"]?.Errors.First().ErrorMessage
                </span>
            }
            <input class="govuk-input @(ViewData.ModelState["ProposedProductUrl"]?.Errors.Count > 0 ? "govuk-input--error" : "")" 
                   id="ProposedProductUrl" 
                   name="ProposedProductUrl" 
                   type="url" 
                   value="@Model.ProposedProductUrl"
                   maxlength="500"
                   aria-describedby="@(ViewData.ModelState["ProposedProductUrl"]?.Errors.Count > 0 ? "ProposedProductUrl-error ProposedProductUrl-hint" : "ProposedProductUrl-hint")">
        </div>

        @if (Model.AvailablePhases.Any())
        {
            <div class="govuk-form-group @(ViewData.ModelState["ProposedPhaseId"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                        Phase
                    </legend>
                    <div id="ProposedPhaseId-hint" class="govuk-hint">
                        The current phase the product is in.
                    </div>
                    @if (ViewData.ModelState["ProposedPhaseId"]?.Errors.Count > 0)
                    {
                        <span class="govuk-error-message">
                            <span class="govuk-visually-hidden">Error:</span>
                            @ViewData.ModelState["ProposedPhaseId"]?.Errors.First().ErrorMessage
                        </span>
                    }
                    <div class="govuk-radios" data-module="govuk-radios">
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" 
                                   id="ProposedPhaseId_0" 
                                   name="ProposedPhaseId" 
                                   type="radio" 
                                   value=""
                                   @(Model.ProposedPhaseId == null ? "checked" : "")>
                            <label class="govuk-label govuk-radios__label" for="ProposedPhaseId_0">
                                No phase assigned
                            </label>
                        </div>
                        @foreach (var phase in Model.AvailablePhases.OrderBy(p => p.SortOrder))
                        {
                            <div class="govuk-radios__item">
                                <input class="govuk-radios__input" 
                                       id="ProposedPhaseId_@phase.Id" 
                                       name="ProposedPhaseId" 
                                       type="radio" 
                                       value="@phase.Id"
                                       @(Model.ProposedPhaseId == phase.Id ? "checked" : "")>
                                <label class="govuk-label govuk-radios__label" for="ProposedPhaseId_@phase.Id">
                                    @phase.Name
                                </label>
                            </div>
                        }
                    </div>
                </fieldset>
            </div>
        }

        @if (Model.AvailableGroups.Any())
        {
            <div class="govuk-form-group @(ViewData.ModelState["ProposedGroupId"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                        Business area
                    </legend>
                    <div id="ProposedGroupId-hint" class="govuk-hint">
                        The area or portfolio of DfE that is primarily responsible for the product.
                    </div>
                    @if (ViewData.ModelState["ProposedGroupId"]?.Errors.Count > 0)
                    {
                        <span class="govuk-error-message">
                            <span class="govuk-visually-hidden">Error:</span>
                            @ViewData.ModelState["ProposedGroupId"]?.Errors.First().ErrorMessage
                        </span>
                    }
                    <div class="govuk-radios" data-module="govuk-radios">
                        <div class="govuk-radios__item">
                            <input class="govuk-radios__input" 
                                   id="ProposedGroupId_0" 
                                   name="ProposedGroupId" 
                                   type="radio" 
                                   value=""
                                   @(Model.ProposedGroupId == null ? "checked" : "")>
                            <label class="govuk-label govuk-radios__label" for="ProposedGroupId_0">
                                No business area assigned
                            </label>
                        </div>
                        @foreach (var group in Model.AvailableGroups.OrderBy(g => g.Name))
                        {
                            <div class="govuk-radios__item">
                                <input class="govuk-radios__input" 
                                       id="ProposedGroupId_@group.Id" 
                                       name="ProposedGroupId" 
                                       type="radio" 
                                       value="@group.Id"
                                       @(Model.ProposedGroupId == group.Id ? "checked" : "")>
                                <label class="govuk-label govuk-radios__label" for="ProposedGroupId_@group.Id">
                                    @group.Name
                                </label>
                            </div>
                        }
                    </div>
                </fieldset>
            </div>
        }

        @if (Model.AvailableChannels.Any())
        {
            <div class="govuk-form-group @(ViewData.ModelState["ProposedChannelIds"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                        Channels
                    </legend>
                    <div id="ProposedChannelIds-hint" class="govuk-hint">
                        Select all channels through which the product is delivered.
                    </div>
                    @if (ViewData.ModelState["ProposedChannelIds"]?.Errors.Count > 0)
                    {
                        <span class="govuk-error-message">
                            <span class="govuk-visually-hidden">Error:</span>
                            @ViewData.ModelState["ProposedChannelIds"]?.Errors.First().ErrorMessage
                        </span>
                    }
                    <div class="govuk-checkboxes" data-module="govuk-checkboxes">
                        @foreach (var channel in Model.AvailableChannels.OrderBy(c => c.Name))
                        {
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" 
                                       id="ProposedChannelIds_@channel.Id" 
                                       name="ProposedChannelIds" 
                                       type="checkbox" 
                                       value="@channel.Id"
                                       @(Model.ProposedChannelIds.Contains(channel.Id) ? "checked" : "")>
                                <label class="govuk-label govuk-checkboxes__label" for="ProposedChannelIds_@channel.Id">
                                    @channel.Name
                                </label>
                            </div>
                        }
                    </div>
                </fieldset>
            </div>
        }

        @if (Model.AvailableTypes.Any())
        {
            <div class="govuk-form-group @(ViewData.ModelState["ProposedTypeIds"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                        Types
                    </legend>
                    <div id="ProposedTypeIds-hint" class="govuk-hint">
                        Select all types of service delivery and functionality that apply to this product or service.
                    </div>
                    @if (ViewData.ModelState["ProposedTypeIds"]?.Errors.Count > 0)
                    {
                        <span class="govuk-error-message">
                            <span class="govuk-visually-hidden">Error:</span>
                            @ViewData.ModelState["ProposedTypeIds"]?.Errors.First().ErrorMessage
                        </span>
                    }
                    <div class="govuk-checkboxes" data-module="govuk-checkboxes">
                        @foreach (var type in Model.AvailableTypes.OrderBy(t => t.Name))
                        {
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" 
                                       id="ProposedTypeIds_@type.Id" 
                                       name="ProposedTypeIds" 
                                       type="checkbox" 
                                       value="@type.Id"
                                       @(Model.ProposedTypeIds.Contains(type.Id) ? "checked" : "")>
                                <label class="govuk-label govuk-checkboxes__label" for="ProposedTypeIds_@type.Id">
                                    @type.Name
                                </label>
                            </div>
                        }
                    </div>
                </fieldset>
            </div>
        }

        <h2 class="govuk-heading-m">Additional information</h2>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedUserDescription"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedUserDescription">
                Tell us in your own words who the users of the product are
            </label>
            <div id="ProposedUserDescription-hint" class="govuk-hint">
                Describe who uses this product on a regular basis. For example, Teachers, school leaders, or DfE Staff.
            </div>
            @if (ViewData.ModelState["ProposedUserDescription"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedUserDescription"]?.Errors.First().ErrorMessage
                </span>
            }
            <textarea class="govuk-textarea @(ViewData.ModelState["ProposedUserDescription"]?.Errors.Count > 0 ? "govuk-textarea--error" : "")" 
                      id="ProposedUserDescription" 
                      name="ProposedUserDescription" 
                      rows="4"
                      maxlength="2000"
                      aria-describedby="@(ViewData.ModelState["ProposedUserDescription"]?.Errors.Count > 0 ? "ProposedUserDescription-error ProposedUserDescription-hint" : "ProposedUserDescription-hint")">@Model.ProposedUserDescription</textarea>
        </div>

        <h3 class="govuk-heading-s">Tell us if any of the team roles have changed</h3>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedDeliveryManager"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedDeliveryManager">
                Delivery Manager
            </label>
            <div id="ProposedDeliveryManager-hint" class="govuk-hint">
                Current: @{
                    var dmContact = Model.Product.ProductContacts?.FirstOrDefault(pc => pc.Role == "delivery_manager");
                    var dmName = dmContact?.UsersPermissionsUser?.DisplayName ?? $"{dmContact?.UsersPermissionsUser?.FirstName} {dmContact?.UsersPermissionsUser?.LastName}".Trim();
                    @(string.IsNullOrEmpty(dmName) ? "(empty)" : dmName)
                }
            </div>
            @if (ViewData.ModelState["ProposedDeliveryManager"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedDeliveryManager"]?.Errors.First().ErrorMessage
                </span>
            }
            <input class="govuk-input @(ViewData.ModelState["ProposedDeliveryManager"]?.Errors.Count > 0 ? "govuk-input--error" : "")" 
                   id="ProposedDeliveryManager" 
                   name="ProposedDeliveryManager" 
                   type="text" 
                   value="@Model.ProposedDeliveryManager"
                   maxlength="255"
                   aria-describedby="@(ViewData.ModelState["ProposedDeliveryManager"]?.Errors.Count > 0 ? "ProposedDeliveryManager-error ProposedDeliveryManager-hint" : "ProposedDeliveryManager-hint")">
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedInformationAssetOwner"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedInformationAssetOwner">
                Information Asset Owner
            </label>
            <div id="ProposedInformationAssetOwner-hint" class="govuk-hint">
                Current: @{
                    var iaoContact = Model.Product.ProductContacts?.FirstOrDefault(pc => pc.Role == "information_asset_owner");
                    var iaoName = iaoContact?.UsersPermissionsUser?.DisplayName ?? $"{iaoContact?.UsersPermissionsUser?.FirstName} {iaoContact?.UsersPermissionsUser?.LastName}".Trim();
                    @(string.IsNullOrEmpty(iaoName) ? "(empty)" : iaoName)
                }
            </div>
            @if (ViewData.ModelState["ProposedInformationAssetOwner"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedInformationAssetOwner"]?.Errors.First().ErrorMessage
                </span>
            }
            <input class="govuk-input @(ViewData.ModelState["ProposedInformationAssetOwner"]?.Errors.Count > 0 ? "govuk-input--error" : "")" 
                   id="ProposedInformationAssetOwner" 
                   name="ProposedInformationAssetOwner" 
                   type="text" 
                   value="@Model.ProposedInformationAssetOwner"
                   maxlength="255"
                   aria-describedby="@(ViewData.ModelState["ProposedInformationAssetOwner"]?.Errors.Count > 0 ? "ProposedInformationAssetOwner-error ProposedInformationAssetOwner-hint" : "ProposedInformationAssetOwner-hint")">
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedProductManager"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedProductManager">
                Product Manager
            </label>
            <div id="ProposedProductManager-hint" class="govuk-hint">
                Current: @{
                    var pmContact = Model.Product.ProductContacts?.FirstOrDefault(pc => pc.Role == "product_manager");
                    var pmName = pmContact?.UsersPermissionsUser?.DisplayName ?? $"{pmContact?.UsersPermissionsUser?.FirstName} {pmContact?.UsersPermissionsUser?.LastName}".Trim();
                    @(string.IsNullOrEmpty(pmName) ? "(empty)" : pmName)
                }
            </div>
            @if (ViewData.ModelState["ProposedProductManager"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedProductManager"]?.Errors.First().ErrorMessage
                </span>
            }
            <input class="govuk-input @(ViewData.ModelState["ProposedProductManager"]?.Errors.Count > 0 ? "govuk-input--error" : "")" 
                   id="ProposedProductManager" 
                   name="ProposedProductManager" 
                   type="text" 
                   value="@Model.ProposedProductManager"
                   maxlength="255"
                   aria-describedby="@(ViewData.ModelState["ProposedProductManager"]?.Errors.Count > 0 ? "ProposedProductManager-error ProposedProductManager-hint" : "ProposedProductManager-hint")">
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["ProposedServiceOwner"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--s" for="ProposedServiceOwner">
                Senior Responsible Officer
            </label>
            <div id="ProposedServiceOwner-hint" class="govuk-hint">
                Current: @{
                    var sroContact = Model.Product.ProductContacts?.FirstOrDefault(pc => pc.Role == "senior_responsible_owner");
                    var sroName = sroContact?.UsersPermissionsUser?.DisplayName ?? $"{sroContact?.UsersPermissionsUser?.FirstName} {sroContact?.UsersPermissionsUser?.LastName}".Trim();
                    @(string.IsNullOrEmpty(sroName) ? "(empty)" : sroName)
                }
            </div>
            @if (ViewData.ModelState["ProposedServiceOwner"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["ProposedServiceOwner"]?.Errors.First().ErrorMessage
                </span>
            }
            <input class="govuk-input @(ViewData.ModelState["ProposedServiceOwner"]?.Errors.Count > 0 ? "govuk-input--error" : "")" 
                   id="ProposedServiceOwner" 
                   name="ProposedServiceOwner" 
                   type="text" 
                   value="@Model.ProposedServiceOwner"
                   maxlength="255"
                   aria-describedby="@(ViewData.ModelState["ProposedServiceOwner"]?.Errors.Count > 0 ? "ProposedServiceOwner-error ProposedServiceOwner-hint" : "ProposedServiceOwner-hint")">
        </div>

        <div class="govuk-form-group @(ViewData.ModelState["Reason"]?.Errors.Count > 0 ? "govuk-form-group--error" : "")">
            <label class="govuk-label govuk-label--m" for="Reason">
                Reason for proposed changes
            </label>
            <div id="Reason-hint" class="govuk-hint">
                Tell us why you're proposing these changes. This will help the reviewer understand your request.
            </div>
            @if (ViewData.ModelState["Reason"]?.Errors.Count > 0)
            {
                <span class="govuk-error-message">
                    <span class="govuk-visually-hidden">Error:</span>
                    @ViewData.ModelState["Reason"]?.Errors.First().ErrorMessage
                </span>
            }
            <textarea class="govuk-textarea @(ViewData.ModelState["Reason"]?.Errors.Count > 0 ? "govuk-textarea--error" : "")" 
                      id="Reason" 
                      name="Reason" 
                      rows="5"
                      maxlength="2000"
                      aria-describedby="@(ViewData.ModelState["Reason"]?.Errors.Count > 0 ? "Reason-error Reason-hint" : "Reason-hint")">@Model.Reason</textarea>
        </div>

        <div class="govuk-button-group">
            <button class="govuk-button" data-module="govuk-button" type="submit" id="submit-changes-btn">
                Submit proposed changes
            </button>
            <a class="govuk-link govuk-link--no-visited-state" href="/product/@(string.IsNullOrWhiteSpace(Model.Product.FipsId) ? Model.Product.DocumentId : Model.Product.FipsId)">Cancel</a>
        </div>

    </form>

  </div>
</div>


